<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src="src/index.js" ></script>
    <script type="text/javascript" src="src/Constants.js" ></script>
    <script type="text/javascript" src="src/Mappers.js" ></script>
    <script type="text/javascript" src="src/PPU.js" ></script>
    <script type="text/javascript" src="src/Controller.js" ></script>
    <title></title>
  </head>
  <body>
    <canvas id="mycanvas" width="256" height="240"
              style="width:30rem; height:30rem;"></canvas>
  </body>
  <script type="text/javascript">
    var cxt = document.querySelector('#mycanvas').getContext('2d');
    var nes = new NES();

    fetch('http://localhost:3000/roms/pooyan.nes',
    { headers: {
       'Content-Type': 'image/jpeg'
    }})
    .then((response) => {
      response.arrayBuffer().then(function(buffer) {
        nes.init(buffer, cxt);
        start(nes);
      });
    });


    function start(nes) {

      var counter = Math.floor(341 * 262 / 3)
      for(var i=0; i<counter ; i++) {
        nes.ppu.cycles = i;
        nes.cycles = i;
        nes.run();

        nes.ppu.sub = 1;
        nes.ppu.run();
        nes.ppu.sub = 2;
        nes.ppu.run();
        nes.ppu.sub = 3;
        nes.ppu.run();
      }

      // nes.consoleCPU();
      // console.log(nes.ppu.dup);

      requestAnimationFrame(() => start(nes));

    }

    document.addEventListener('keydown', (event) => {
      const type1 = nes.ctrl1.getType1(event.key);
      type1 && nes.ctrl1.pressButton(type1);

      const type2 = nes.ctrl2.getType2(event.key);
      type2 && nes.ctrl2.pressButton(type2);
    }, false);

    document.addEventListener('keyup', (event) => {
      const type1 = nes.ctrl1.getType1(event.key);
      type1 && nes.ctrl1.releaseButton(type1);

      const type2 = nes.ctrl2.getType2(event.key);
      type2 && nes.ctrl2.releaseButton(type2);
    }, false);

  </script>
</html>
